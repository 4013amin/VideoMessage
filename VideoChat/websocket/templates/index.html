<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تماس تصویری WebRTC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazir', sans-serif;
            padding: 20px;
            direction: rtl;
            background-color: #f8f9fa;
        }

        video {
            border: 1px solid #ccc;
            border-radius: 10px;
            margin: 10px 0;
            width: 100%;
            max-width: 320px;
        }

        .video-container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-center mb-4">تماس تصویری بین دو کاربر</h2>

    <div class="row mb-3">
        <div class="col-md-6">
            <label for="myUsername" class="form-label">نام کاربری من:</label>
            <input id="myUsername" class="form-control" placeholder="مثلاً ali123"/>
        </div>
        <div class="col-md-6">
            <label for="targetUsername" class="form-label">نام کاربری مقصد:</label>
            <input id="targetUsername" class="form-control" placeholder="مثلاً sara456"/>
        </div>
    </div>

    <button onclick="startCall()" class="btn btn-primary mb-4">شروع تماس</button>

    <div class="row">
        <div class="col-md-6 video-container">
            <h3>ویدیو من:</h3>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div class="col-md-6 video-container">
            <h3>ویدیو طرف مقابل:</h3>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
    </div>
</div>

<script>
    let localVideo = document.getElementById("localVideo");
    let remoteVideo = document.getElementById("remoteVideo");
    let myUsernameInput = document.getElementById("myUsername");
    let targetUsernameInput = document.getElementById("targetUsername");
    let localStream;
    let pc;
    let socket;

    window.onload = async () => {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            localVideo.srcObject = localStream;
        } catch (error) {
            console.error("دسترسی رد شد:", error);
            alert("مشکلی در دسترسی به دوربین یا میکروفون پیش آمد.");
        }
    };


    async function startCall() {
        const myUsername = myUsernameInput.value.trim();
        const targetUsername = targetUsernameInput.value.trim();

        if (!myUsername || !targetUsername) {
            alert("هر دو نام کاربری را وارد کنید.");
            return;
        }

        console.log(`اتصال WebSocket برای کاربر: ${myUsername}`);
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        socket = new WebSocket(`${protocol}://${window.location.host}/ws/video/${myUsername}/`);

        pc = new RTCPeerConnection({
            iceServers: [{urls: "stun:stun.l.google.com:19302"}]
        });

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.ontrack = (event) => {
            if (event.streams && event.streams[0]) {
                remoteVideo.srcObject = event.streams[0];
                console.log("دریافت استریم ویدیوی طرف مقابل.");
            }
        };

        pc.onicecandidate = (event) => {
            if (event.candidate) {
                socket.send(JSON.stringify({
                    type: "ice",
                    target: targetUsername,
                    candidate: event.candidate
                }));
                console.log("ارسال کاندیدای ICE:", event.candidate);
            }
        };

        socket.onmessage = async (e) => {
            const data = JSON.parse(e.data);
            console.log("دریافت پیام WebSocket:", data);

            if (data.type === "offer") {
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.send(JSON.stringify({
                    type: "answer",
                    target: targetUsername,
                    answer
                }));
                console.log("ارسال پاسخ (answer) برای offer.");
            } else if (data.type === "answer") {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                console.log("دریافت و تنظیم پاسخ (answer).");
            } else if (data.type === "ice") {
                if (data.candidate) {
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    console.log("اضافه شدن کاندیدای ICE:", data.candidate);
                }
            }
        };

        socket.onopen = async () => {
            console.log("اتصال WebSocket برقرار شد.");
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.send(JSON.stringify({
                type: "offer",
                target: targetUsername,
                offer
            }));
            console.log("ارسال پیشنهاد (offer).");
        };

        socket.onerror = (e) => {
            console.error("خطا در WebSocket:", e);
            alert("خطا در اتصال به WebSocket.");
        };

        socket.onclose = () => {
            console.log("اتصال WebSocket بسته شد.");
        };
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>